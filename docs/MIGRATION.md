# Migration Guide: Venus/Planet to Planet Go

This guide helps you migrate from Venus/Planet (Python 2.x) to Planet Go.

## Quick Start

1. **Install Planet Go** → Build the binary
2. **Test with existing config** → Should fetch feeds
3. **Migrate templates** → Convert to Go syntax
4. **Parallel testing** → Run both versions
5. **Cutover** → Switch to Planet Go

## Step 1: Install Planet Go

```bash
git clone https://github.com/alexey-ott/planet-go
cd planet-go
go build -o planet ./cmd/planet
```

Or install with Go:

```bash
go install github.com/alexey-ott/planet-go/cmd/planet@latest
```

## Step 2: Test with Existing Config

Your existing `config.ini` should work as-is for the `[Planet]` section and feed sections:

```bash
./planet -c /path/to/existing/config.ini
```

This will:
- ✅ Fetch feeds and cache them
- ✅ Parse RSS/Atom feeds
- ❌ Template rendering will fail (templates need migration)

**Expected output:**
```
INFO  starting planet feeds=45
INFO  fetching feeds
INFO  feed fetched url=https://example.com/feed entries=10
...
INFO  fetch complete success=45 errors=0
INFO  loaded entries count=450
INFO  rendering templates count=2
ERROR template failed file=index.html.tmpl error=...
```

Don't worry about template errors - that's expected and we'll fix it in the next step.

## Step 3: Migrate Templates

### Syntax Changes

Convert htmltmpl syntax to Go templates:

#### Variables

**Before (htmltmpl):**
```html
<TMPL_VAR name>
<TMPL_VAR name ESCAPE="HTML">
<TMPL_VAR author_name>
```

**After (Go template):**
```html
{{.Name}}
{{.Name}}  <!-- HTML escaping is automatic -->
{{.AuthorName}}  <!-- Note: CamelCase -->
```

#### Loops

**Before:**
```html
<TMPL_LOOP Items>
  <h2><TMPL_VAR title></h2>
  <p><TMPL_VAR content></p>
</TMPL_LOOP>
```

**After:**
```html
{{range .Items}}
  <h2>{{.Title}}</h2>
  <p>{{.Content}}</p>
{{end}}
```

#### Conditionals

**Before:**
```html
<TMPL_IF author_name>
  <p>By <TMPL_VAR author_name></p>
</TMPL_IF>
```

**After:**
```html
{{if .AuthorName}}
  <p>By {{.AuthorName}}</p>
{{end}}
```

#### Nested Conditionals

**Before:**
```html
<TMPL_IF new_date>
  <h3><TMPL_VAR date></h3>
</TMPL_IF>
```

**After:**
```html
{{if .NewDate}}
  <h3>{{.Date}}</h3>
{{end}}
```

### Template Data Structure

Available in templates:

**Planet-level (top-level):**
```
.Name          string   - Planet name
.Link          string   - Planet URL
.OwnerName     string   - Owner name
.OwnerEmail    string   - Owner email
.Generator     string   - "Planet Go"
.Date          string   - Current date (formatted)
.DateISO       string   - Current date (ISO 8601)
.Items         []Entry  - Array of entries
.Channels      []Channel - Array of feeds
```

**Entry fields (inside `{{range .Items}}`):**
```
.Title         string   - Entry title
.Link          string   - Entry URL
.Content       HTML     - Entry content (safe HTML)
.Author        string   - Author name
.AuthorEmail   string   - Author email
.Date          string   - Entry date (formatted)
.DateISO       string   - Entry date (ISO 8601)
.ID            string   - Entry ID/GUID
.ChannelName   string   - Feed name
.ChannelLink   string   - Feed URL
.ChannelTitle  string   - Feed title
.NewDate       bool     - True if date changed from previous entry
.NewChannel    bool     - True if channel changed from previous entry
```

**Channel fields (inside `{{range .Channels}}`):**
```
.Name          string   - Channel name
.Link          string   - Channel URL
.Title         string   - Channel title
```

### Full Template Example

**Before (htmltmpl):**
```html
<!DOCTYPE html>
<html>
<head>
  <title><TMPL_VAR name></title>
</head>
<body>
  <h1><TMPL_VAR name></h1>
  <p>Last updated: <TMPL_VAR date></p>

  <TMPL_LOOP Items>
    <TMPL_IF new_date>
      <h2><TMPL_VAR date></h2>
    </TMPL_IF>

    <article>
      <h3><a href="<TMPL_VAR link ESCAPE="HTML">"><TMPL_VAR title></a></h3>
      <p class="meta">
        <TMPL_IF author_name>by <TMPL_VAR author_name> - </TMPL_IF>
        from <a href="<TMPL_VAR channel_link>"><TMPL_VAR channel_name></a>
      </p>
      <div class="content">
        <TMPL_VAR content>
      </div>
    </article>
  </TMPL_LOOP>

  <footer>
    <p>Generated by <TMPL_VAR generator></p>
  </footer>
</body>
</html>
```

**After (Go template):**
```html
<!DOCTYPE html>
<html>
<head>
  <title>{{.Name}}</title>
</head>
<body>
  <h1>{{.Name}}</h1>
  <p>Last updated: {{.Date}}</p>

  {{range .Items}}
    {{if .NewDate}}
      <h2>{{.Date}}</h2>
    {{end}}

    <article>
      <h3><a href="{{.Link}}">{{.Title}}</a></h3>
      <p class="meta">
        {{if .Author}}by {{.Author}} - {{end}}
        from <a href="{{.ChannelLink}}">{{.ChannelName}}</a>
      </p>
      <div class="content">
        {{.Content}}
      </div>
    </article>
  {{end}}

  <footer>
    <p>Generated by {{.Generator}}</p>
  </footer>
</body>
</html>
```

### Key Differences

1. **HTML Escaping:** Go templates automatically escape HTML by default. Use `template.HTML` type for safe HTML content (already done for `.Content`).

2. **Field Names:** Go templates use CamelCase (`.AuthorName` not `.author_name`).

3. **No ESCAPE directive:** Remove `ESCAPE="HTML"` - it's automatic.

4. **End tags:** Always close with `{{end}}`, not `</TMPL_IF>` or `</TMPL_LOOP>`.

5. **Whitespace:** Go templates preserve whitespace, so format carefully.

## Step 4: Parallel Testing

Run both Venus/Planet and Planet Go in parallel to compare outputs:

```bash
# Terminal 1: Run Venus/Planet
cd /path/to/venus
python planet.py config.ini

# Terminal 2: Run Planet Go (with different output dir)
cd /path/to/planet-go
# Edit config-test.ini to use output_dir = ./output-go
./planet -c config-test.ini

# Compare outputs
diff -r output/ output-go/
```

**What to check:**
- Entry ordering (should be newest first)
- Date formatting
- Content rendering
- Feed metadata
- HTML validity

**Common differences:**
- Date formats may vary (check `date_format` config)
- HTML entities may be encoded differently
- Whitespace may differ slightly

## Step 5: Cutover

Once satisfied with Planet Go outputs:

1. **Update cron job:**
   ```bash
   # Before
   0 * * * * cd /path/to/venus && python planet.py config.ini
   
   # After
   0 * * * * cd /path/to/planet-go && ./planet -c config.ini
   ```

2. **Keep backup:** Don't delete Venus/Planet for a few weeks

3. **Monitor:** Check logs and output regularly

## Unsupported Features

These features from Venus/Planet are **not implemented** in the MVP:

### Not Supported
- ❌ Multiple template engines (Django, XSLT, Genshi)
- ❌ Complex filter/plugin system
- ❌ Twitter integration
- ❌ PubSubHubbub support
- ❌ Admin web interface
- ❌ Activity threshold marking
- ❌ Concurrent feed fetching (coming in v0.2.0)

### Workarounds

**If you need Django templates:**
- Wait for future support, or
- Convert to Go templates (recommended), or
- Continue using Venus/Planet

**If you need complex filtering:**
- Use basic regex patterns (`filter` and `exclude` in config), or
- Post-process the output with external scripts

**If you need concurrent fetching:**
- Wait for v0.2.0 (planned), or
- Run multiple instances with split configs

## Troubleshooting

### Template Parse Errors

**Error:** `template: index.html.tmpl:10: unexpected "}" in command`

**Cause:** Unclosed `{{range}}` or `{{if}}` block

**Solution:** Check that every `{{range}}` and `{{if}}` has a matching `{{end}}`

---

**Error:** `template: index.html.tmpl:15: unexpected "<" in operand`

**Cause:** Using htmltmpl syntax `<TMPL_VAR>`

**Solution:** Replace with Go syntax `{{.Var}}`

---

**Error:** `can't evaluate field AuthorName in type renderer.TemplateEntry`

**Cause:** Wrong field name or capitalization

**Solution:** Check field names match exactly (case-sensitive)

### Feed Fetch Errors

**Error:** `feed failed url=... error=context deadline exceeded`

**Cause:** Feed took too long to fetch

**Solution:** Increase `feed_timeout` in config:
```ini
feed_timeout = 60  # 60 seconds instead of default 20
```

---

**Error:** `feed failed url=... error=parse feed: unsupported feed type`

**Cause:** Feed format not recognized by gofeed

**Solution:**
- Check if feed URL is valid (try in browser)
- Check if it's actually RSS/Atom (some sites lie)
- Report to gofeed project if it's a valid feed

### Output Differences

**Issue:** Dates formatted differently

**Solution:** Match the `date_format` string from Venus config:
```ini
# Python format -> Go format
# %B %d, %Y    -> January 02, 2006
# %Y-%m-%d     -> 2006-01-02
# %I:%M %p     -> 03:04 PM
```

Go uses reference time `Mon Jan 2 15:04:05 MST 2006` instead of strftime codes.

---

**Issue:** Entries in different order

**Cause:** Different sorting algorithm

**Solution:** Both should sort newest-first. Check entry dates in cache files:
```bash
cat cache/*.json | jq '.entries[].date'
```

---

**Issue:** Some entries missing

**Cause:** Filtering or pagination differences

**Solution:**
- Check `filter` and `exclude` patterns
- Check `items_per_page` and `days_per_page` settings
- Compare with `log_level = DEBUG` to see what's filtered

## Migration Checklist

- [ ] Planet Go binary built
- [ ] Tested with existing config
- [ ] Feeds fetch successfully
- [ ] All templates converted to Go syntax
- [ ] Templates render without errors
- [ ] Output matches Venus/Planet output
- [ ] Cron job updated
- [ ] Monitoring in place
- [ ] Venus/Planet kept as backup

## Getting Help

- **GitHub Issues:** https://github.com/alexey-ott/planet-go/issues
- **Design Doc:** `docs/plans/2025-01-08-planet-go-design.md`
- **Examples:** See `examples/` directory

## Additional Resources

- [Go template documentation](https://pkg.go.dev/text/template)
- [HTML template documentation](https://pkg.go.dev/html/template)
- [Planet Venus documentation](http://www.intertwingly.net/code/venus/docs/)

